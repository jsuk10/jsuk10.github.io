<script>
(() => {
  (async () => {
    const url = '{{ "/assets/users.json?v=" | append: site.time | relative_url }}';

    // fetch
    const res = await fetch(url).catch(e => {
      console.error('[users.js] FetchError:', e);
      return null;
    });
    if (!res) return;
    if (!res.ok) {
      console.error('[users.js] FetchError:', `HTTP ${res.status} ${res.statusText}`);
      return;
    }

    // parse json
    let data = null;
    try {
      data = await res.json();
    } catch (e) {
      console.error('[users.js] JSONError: users.json 파싱 실패', e);
      return;
    }

    // 오늘(KST) YYYYMMDD
    const fmt = new Intl.DateTimeFormat('en-CA', {
      timeZone: 'Asia/Seoul', year: 'numeric', month: '2-digit', day: '2-digit'
    });
    const [y, m, d] = fmt.format(new Date()).split('-');
    const today = `${y}${m}${d}`;

    // 값 추출: series(오늘) → users → total_users
    let label = '오늘 방문자';
    let value = null;

    if (data && Array.isArray(data.series)) {
      const hit = data.series.find(s =>
        String(s?.date) === today && typeof s?.users === 'number'
      );
      if (hit) value = hit.users;
    }
    if (value == null && typeof data?.users === 'number') {
      value = data.users;
    }
    if (value == null && typeof data?.total_users === 'number') {
      value = data.total_users;
      label = '최근 집계 방문자';
    }
    if (value == null) {
      console.error('[users.js] DataError: 지원하지 않는 스키마', data);
      return;
    }

    // DOM 추가
    const footer = document.querySelector('footer');
    if (!footer) {
      console.error('[users.js] DOMError: footer 요소를 찾을 수 없습니다.');
      return;
    }
    const el = document.createElement('div');
    el.style.fontSize = '0.9rem';
    el.style.opacity = '0.8';
    el.textContent = `${label}: ${value.toLocaleString()}명`;
    footer.appendChild(el);
  })();
})();
</script>
