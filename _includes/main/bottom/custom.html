<script>
(() => {
  (async () => {
    const url = '{{ "/assets/users.json?v=" | append: site.time | relative_url }}';

    // fetch
    const res = await fetch(url).catch(e => {
      console.error('[users.js] FetchError:', e);
      return null;
    });
    if (!res) return;
    if (!res.ok) {
      console.error('[users.js] FetchError:', `HTTP ${res.status} ${res.statusText}`);
      return;
    }

    // parse
    let data = null;
    try {
      data = await res.json();
    } catch (e) {
      console.error('[users.js] JSONError: users.json 파싱 실패', e);
      return;
    }

    // -------- 값 추출 --------
    const kstFmt = new Intl.DateTimeFormat('en-CA', {
      timeZone: 'Asia/Seoul', year: 'numeric', month: '2-digit', day: '2-digit'
    });
    const [y, m, d] = kstFmt.format(new Date()).split('-');
    const todayYMD = `${y}${m}${d}`;
    const todayLabel = `${m}.${d}`; // "10.15" 형식

    let todayUsers = null;
    if (typeof data?.today_users === 'number') {
      todayUsers = data.today_users;
    } else {
      const hit = Array.isArray(data?.series)
        ? data.series.find(s => String(s?.date) === todayYMD && typeof s?.users === 'number')
        : null;
      if (hit) todayUsers = hit.users;
    }

    let totalUsers = null;
    if (typeof data?.total_users === 'number') {
      totalUsers = data.total_users;
    } else if (Array.isArray(data?.monthly_series)) {
      totalUsers = data.monthly_series.reduce((acc, it) => acc + (Number(it?.users) || 0), 0);
    } else if (Array.isArray(data?.series)) {
      totalUsers = data.series.reduce((acc, it) => acc + (Number(it?.users) || 0), 0);
    }

    if (todayUsers == null || totalUsers == null) {
      console.error('[users.js] DataError: 필요한 필드(today_users/total_users)가 없습니다.', data);
      return;
    }

    // -------- DOM 표시 (줄바꿈) --------
    const footer = document.querySelector('.footer.py-4.js-page-footer:last-of-type');
    if (!footer) {
      console.error('[users.js] DOMError: footer 요소를 찾을 수 없습니다.');
      return;
    }

    const el = document.createElement('div');
    el.style.fontSize = '0.9rem';
    el.style.opacity = '0.8';
    el.style.display = 'flex';
    el.style.flexDirection = 'column';   // 줄바꿈
    el.style.rowGap = '0.5rem';          // 한 줄 띄우기 간격
    el.style.paddingRight = '12px';

    const nf = (n) => Number(n).toLocaleString();

    const todayDiv = document.createElement('div');
    todayDiv.textContent = `금일 (${todayLabel}) 방문자: ${nf(todayUsers)}명`;
    todayDiv.style.whiteSpace = 'nowrap';

    const totalDiv = document.createElement('div');
    totalDiv.textContent = `누적 방문자 : ${nf(totalUsers + todayUsers)}명`;
    totalDiv.style.whiteSpace = 'nowrap';

    el.appendChild(todayDiv);
    el.appendChild(totalDiv);
    footer.appendChild(el);
  })();
})();
</script>